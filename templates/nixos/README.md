# nixOS Jail

## Disclaimer

**Experimental. While nixOS seems to be completely functional under jailmaker/systemd-nspawn, it has not been extensively tested yet.**

## Warning

**DO NOT USE HOST-NETWORKING with `CAP_NET_ADMIN` or `docker_compatible` for nixOS.** nixOS applies firewall rules during rebuild and this will result in those being added to the host.

## Procedure

Create the jail:

```bash
jlmkr create --distro=nixos --release=23.11 nixos-jail
```

You will need to use `macvlan` or `bridge` interface, otherwise nix won't be able to rebuild. More info on networking [here](../../docs/network.md)

Edit your config to add an interface:

```
systemd_nspawn_user_args=--network-bridge=br1
```

Start the jail and get a shell:

```bash
jlmkr start nixos-jail
jlmkr shell nixos-jail
```

Check if you automatically got an IP with `ifconfig`. If you don't see the interface, it doesn't have an IP yet, try `ifconfig -a` to see its name.

If not, you can assign an IP address and gateway to the created interface if it wasn't automatically (required for first rebuild):

(replace IP addresses and interface as per your network)
```bash
ifconfig host0 192.168.1.123 netmask 255.255.255.0 
route add default gw 192.168.1.1
```

Edit the `/etc/nixos/configuration.nix` and remove:

```
  imports =
    [
      # Include the default lxd configuration.
      "${modulesPath}/virtualisation/lxc-container.nix"
      # Include the container-specific autogenerated configuration.
      ./lxd.nix
    ];
  networking.useDHCP = false;
  networking.interfaces.eth0.useDHCP = true;
```

And add the following in its place:

```
  imports = [];
  boot.isContainer = true;
  boot.loader.initScript.enable = true;
  networking.hostName = "YOURHOSTNAMEHERE";
  networking.useNetworkd = true;
  networking.useDHCP = true;
  networking.useHostResolvConf = false;
  networking.firewall.enable = false;
```

Finally, rebuild:

```bash
nixos-rebuild switch
```

Thats it!

You will have to exit the shell and restart the jail for the hostname to be applied.
